name: Python CI - Test, Deploy, Unified Report

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
# ==========================
# 1️⃣ TEST JOB
# ==========================
  test:
    runs-on: ubuntu-latest
    outputs:
      test_result: ${{ steps.result.outputs.test_result }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pytest pytest-html

      # Try to download previous report (silent if not exists)
      - name: Download previous report
        uses: actions/download-artifact@v4
        with:
          name: unified-report
          path: old
        continue-on-error: true

      - name: Run application
        run: |
          python app.py | tee app.log

      - name: Run tests
        run: |
          pytest tests/test_example.py \
            --html=pytest.html \
            --self-contained-html \
            --capture=tee-sys | tee pytest.log
        continue-on-error: true

      - name: Build unified report
        run: |
          cp pytest.html unified_report.html

          echo "<hr><h2>Workflow Logs</h2>" >> unified_report.html

          if [ -f old/unified_report.html ]; then
            echo "<details><summary><b>Previous Runs</b></summary>" >> unified_report.html
            sed '1,/<body>/d' old/unified_report.html | sed '/<\/body>/,$d' >> unified_report.html
            echo "</details><hr>" >> unified_report.html
          fi

          echo "<h3>Application Logs</h3><pre>" >> unified_report.html
          cat app.log >> unified_report.html
          echo "</pre>" >> unified_report.html

          echo "<h3>Test Logs</h3><pre>" >> unified_report.html
          cat pytest.log >> unified_report.html
          echo "</pre>" >> unified_report.html

      - name: Upload unified report
        uses: actions/upload-artifact@v4
        with:
          name: unified-report
          path: unified_report.html

      - name: Set test result
        id: result
        run: |
          grep -q "FAILED" pytest.log && \
          echo "test_result=fail" >> $GITHUB_OUTPUT || \
          echo "test_result=success" >> $GITHUB_OUTPUT

# ==========================
# 2️⃣ DEPLOY JOB
# ==========================
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ needs.test.outputs.test_result == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Deploy
        run: |
          chmod +x deploy.sh
          ./deploy.sh | tee deploy.log

      - name: Upload deploy logs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log

# ==========================
# 3️⃣ EMAIL JOB (ALWAYS)
# ==========================
  email:
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: unified-report
          path: .

      - name: Download deploy log
        uses: actions/download-artifact@v4
        with:
          name: deploy-log
          path: .
        continue-on-error: true

      - name: Send email
        run: |
         python - <<EOF
         import smtplib, ssl, os
         from email.mime.multipart import MIMEMultipart
         from email.mime.text import MIMEText
         from email.mime.base import MIMEBase
         from email import encoders

         sender = "${{ secrets.EMAIL_USERNAME }}"
         password = "${{ secrets.EMAIL_PASSWORD }}"
         receiver = "slimihoussem1@gmail.com"

         test_status = "PASSED" if "${{ needs.test.outputs.test_result }}" == "success" else "FAILED"
         deploy_status = "DONE" if os.path.exists("deploy.log") else "SKIPPED"

         msg = MIMEMultipart()
         msg["From"] = sender
         msg["To"] = receiver
         msg["Subject"] = "CI Report – Tests & Deployment"

         msg.attach(MIMEText(f"""
         CI Pipeline Finished

         Tests: {test_status}
         Deployment: {deploy_status}

         The attached HTML contains:
         - Pytest statistics & environment
         - Test results
         - Workflow logs
         """, "plain"))

         with open("unified_report.html", "rb") as f:
             part = MIMEBase("application", "octet-stream")
             part.set_payload(f.read())
             encoders.encode_base64(part)
             part.add_header("Content-Disposition", "attachment; filename=report.html")
             msg.attach(part)

         with smtplib.SMTP("smtp.gmail.com", 587) as s:
             s.starttls()   # ✅ FIXED HERE
             s.login(sender, password)
             s.send_message(msg)

         print("Email sent successfully")
         EOF
