name: Python CI - Generate Test Report and Update Branch

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write  # allow GitHub Actions to push to repo

jobs:
  test-and-update-report:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required to push

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html

      # 4Ô∏è‚É£ Run your application
      - name: Run application
        run: |
          python app.py

      # 5Ô∏è‚É£ Run tests and generate HTML report
      - name: Run tests and generate report
        run: |
          pytest tests/test_example.py \
            --html=report.html \
            --self-contained-html

      # 6Ô∏è‚É£ Push report.html to dedicated branch
      - name: Push report to ci-reports branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to ci-reports branch
          git checkout -B ci-reports

          # Add and commit report
          git add report.html
          git commit -m "CI: update test report [skip ci]" || echo "No changes to commit"

          # Force push to ci-reports branch
          git push origin ci-reports --force

      # 7Ô∏è‚É£ Optional: send email with report
      - name: Send email with test report
        run: |
          python - <<EOF
          import smtplib, ssl
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders

          sender_email = "${{ secrets.EMAIL_USERNAME }}"
          receiver_email = "slimihoussem1@gmail.com"
          password = "${{ secrets.EMAIL_PASSWORD }}"
          subject = f"CI Test Report - ${{ github.repository }}"

          msg = MIMEMultipart()
          msg['From'] = sender_email
          msg['To'] = receiver_email
          msg['Subject'] = subject

          body = f"""
          Hello Houssem,

          The automated tests have finished.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          Please find the test report attached.

          Regards,
          GitHub Actions ü§ñ
          """
          msg.attach(MIMEText(body, 'plain'))

          filename = "report.html"
          with open(filename, "rb") as attachment:
              part = MIMEBase("application", "octet-stream")
              part.set_payload(attachment.read())
              encoders.encode_base64(part)
              part.add_header("Content-Disposition", f"attachment; filename={filename}")
              msg.attach(part)

          context = ssl.create_default_context()
          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls(context=context)
              server.login(sender_email, password)
              server.sendmail(sender_email, receiver_email, msg.as_string())

          print("Email sent successfully!")
          EOF
