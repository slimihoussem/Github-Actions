name: CI Tests + Deploy + Report

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      test_result: ${{ steps.test_status.outputs.result }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html pytest-metadata

      - name: Run application (capture logs)
        run: |
          python app.py > app.log 2>&1 || true

      - name: Run tests (capture logs)
        run: |
          pytest tests \
            --html=pytest_report.html \
            --self-contained-html \
            --capture=tee-sys \
            | tee pytest.log
        continue-on-error: true

      - name: Determine test status
        id: test_status
        run: |
          if grep -q "FAILED" pytest.log; then
            echo "result=failure" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate unified report
        run: |
          cat <<EOF > unified_report.html
          <html>
          <head><title>CI Unified Report</title></head>
          <body>
          <h1>CI Report</h1>

          <h2>Test Summary</h2>
          <p>Status: <b>${{ steps.test_status.outputs.result }}</b></p>

          <h2>Pytest HTML Report</h2>
          <iframe src="pytest_report.html" width="100%" height="600"></iframe>

          <h2>Application Logs</h2>
          <pre>$(cat app.log)</pre>

          <h2>Pytest Logs</h2>
          <pre>$(cat pytest.log)</pre>

          </body>
          </html>
          EOF

      - name: Upload unified report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unified-report
          path: |
            unified_report.html
            pytest_report.html
            app.log
            pytest.log

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: needs.test.outputs.test_result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy
        run: |
          chmod +x deploy.sh
          ./deploy.sh | tee deploy.log

      - name: Upload deploy logs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs
          path: deploy.log

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: unified-report

      - name: Send email
        run: |
          python - <<EOF
          import smtplib, os
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders

          sender = "${{ secrets.EMAIL_USERNAME }}"
          password = "${{ secrets.EMAIL_PASSWORD }}"
          receiver = "slimihoussem1@gmail.com"

          test_status = "${{ needs.test.outputs.test_result }}"

          msg = MIMEMultipart()
          msg["From"] = sender
          msg["To"] = receiver
          msg["Subject"] = f"CI Status: {test_status.upper()}"

          msg.attach(MIMEText(f"""
          CI Finished

          Tests: {test_status}
          Deployment: {'DONE' if test_status == 'success' else 'SKIPPED'}

          Unified report attached.
          """, "plain"))

          with open("unified_report.html", "rb") as f:
              part = MIMEBase("application", "octet-stream")
              part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header("Content-Disposition", "attachment; filename=report.html")
              msg.attach(part)

          with smtplib.SMTP("smtp.gmail.com", 587) as s:
              s.starttls()
              s.login(sender, password)
              s.send_message(msg)

          print("Email sent")
          EOF
