name: CI Tests + Deploy + Unified Report

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    outputs:
      test_result: ${{ steps.test_status.outputs.result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html pytest-metadata

      # -----------------------------
      # Application logs
      # -----------------------------
      - name: Run application (capture logs)
        run: |
          python app.py > app.log 2>&1 || true

      # -----------------------------
      # Tests + pytest-html report
      # -----------------------------
      - name: Run tests and generate report
        run: |
          pytest tests \
            --html=report.html \
            --self-contained-html \
            --capture=tee-sys \
            --log-cli-level=INFO \
            > pytest_session.log 2>&1
        continue-on-error: true

      # -----------------------------
      # Determine test status
      # -----------------------------
      - name: Determine test status
        id: test_status
        run: |
          if grep -q "FAILED" pytest_session.log; then
            echo "result=failure" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # Deploy only if tests pass
      # -----------------------------
      - name: Deploy
        if: steps.test_status.outputs.result == 'success'
        run: |
          chmod +x deploy.sh
          ./deploy.sh | tee deploy.log

      # -----------------------------
      # Append logs to SAME report.html
      # -----------------------------
      - name: Append logs to report.html
        if: always()
        run: |
          cat <<'EOF' >> report.html

          <hr>
          <h2>Previous Logs</h2>
          <pre>No previous logs available</pre>

          <h2>New Application Logs</h2>
          <pre>
          EOF

          sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' app.log >> report.html

          cat <<'EOF' >> report.html
          </pre>

          <h2>New Test Logs</h2>
          <pre>
          EOF

          sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' pytest_session.log >> report.html

          cat <<'EOF' >> report.html
          </pre>

          <h2>Deployment Logs</h2>
          <pre>
          EOF

          if [ -f deploy.log ]; then
            sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' deploy.log >> report.html
          else
            echo "Deployment skipped." >> report.html
          fi

          echo "</pre>" >> report.html

      # -----------------------------
      # Upload unified report
      # -----------------------------
      - name: Upload unified report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unified-report
          path: report.html

  # =============================
  # EMAIL NOTIFICATION (FINAL)
  # =============================
  notify:
    needs: ci
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: unified-report

      - name: Send email with report
        run: |
          python - <<EOF
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders

          sender = "${{ secrets.EMAIL_USERNAME }}"
          password = "${{ secrets.EMAIL_PASSWORD }}"

          to_email = "slimihoussem1@gmail.com"
          cc_email = "chokri.gammoudi@gmail.com"   
          recipients = [to_email, cc_email]

          repo = "${{ github.repository }}"
          branch = "${{ github.ref_name }}"
          status = "${{ needs.ci.outputs.test_result }}"

          commit_sha = "${{ github.sha }}"[:7]
          commit_msg = """${{ github.event.head_commit.message }}"""
          commit_author = "${{ github.event.head_commit.author.name }}"

          msg = MIMEMultipart()
          msg["From"] = sender
          msg["To"] = to_email
          msg["Cc"] = cc_email
          msg["Subject"] = f"[CI {status.upper()}] {repo} ({branch})"

          body = f"""
          Hello,

          CI pipeline finished.

          Repository : {repo}
          Branch     : {branch}

          Commit     : {commit_sha}
          Author     : {commit_author}
          Message    : {commit_msg}

          Tests      : {status.upper()}

          Please find the detailed report attached.

          Regards,
          GitHub Actions ðŸ¤–
          """

          msg.attach(MIMEText(body, "plain"))

          with open("report.html", "rb") as f:
              part = MIMEBase("application", "octet-stream")
              part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header(
                  "Content-Disposition",
                  "attachment; filename=report.html"
              )
              msg.attach(part)

          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls()
              server.login(sender, password)
              server.sendmail(sender, recipients, msg.as_string())

          print("Email sent successfully")
          EOF
