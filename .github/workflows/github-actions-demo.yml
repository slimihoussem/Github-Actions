name: CI Tests + Deploy + Report

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      test_result: ${{ steps.test_status.outputs.result }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html pytest-metadata

      - name: Run application (capture logs)
        run: |
          python app.py > app.log 2>&1 || true

      - name: Run tests (capture logs)
        run: |
          pytest tests \
            --html=pytest_report.html \
            --self-contained-html \
            --capture=tee-sys \
            | tee pytest.log
        continue-on-error: true

      - name: Determine test status
        id: test_status
        run: |
          if grep -q "FAILED" pytest.log; then
            echo "result=failure" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate unified report
        run: |
          cat <<EOF > unified_report.html
          <html>
          <head><title>CI Unified Report</title></head>
          <body>
          <h1>CI Report</h1>

          <h2>Test Summary</h2>
          <p>Status: <b>${{ steps.test_status.outputs.result }}</b></p>

          <h2>Pytest HTML Report</h2>
          <iframe src="pytest_report.html" width="100%" height="600"></iframe>

          <h2>Application Logs</h2>
          <pre>$(cat app.log)</pre>

          <h2>Pytest Logs</h2>
          <pre>$(cat pytest.log)</pre>

          </body>
          </html>
          EOF

      - name: Upload unified report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unified-report
          path: |
            unified_report.html
            pytest_report.html
            app.log
            pytest.log

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: needs.test.outputs.test_result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy
        run: |
          chmod +x deploy.sh
          ./deploy.sh | tee deploy.log

      - name: Upload deploy logs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs
          path: deploy.log

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: unified-report

      - name: Send email
        run: |
          python - <<EOF
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders

          sender = "${{ secrets.EMAIL_USERNAME }}"
          password = "${{ secrets.EMAIL_PASSWORD }}"

          to_email = "slimihoussem1@gmail.com"
          cc_email = "chokri.gammoudi@gmail.com"   
          recipients = [to_email, cc_email]

          repo = "${{ github.repository }}"
          test_status = "${{ needs.test.outputs.test_result }}"
          deploy_status = "DONE" if test_status == "success" else "SKIPPED"

          commit_sha = "${{ github.sha }}"[:7]
          commit_message = """${{ github.event.head_commit.message }}"""
          commit_author = "${{ github.event.head_commit.author.name }}"
          branch = "${{ github.ref_name }}"

          # Email
          msg = MIMEMultipart()
          msg["From"] = sender
          msg["To"] = to_email
          msg["Cc"] = cc_email
          msg["Subject"] = f"[CI {test_status.upper()}] {repo} ({branch})"

          body = f"""
          Hello,

          CI pipeline has finished.

          Repository : {repo}
          Branch     : {branch}

          Commit     : {commit_sha}
          Author     : {commit_author}
          Message    : {commit_message}

          Tests      : {test_status.upper()}
          Deployment : {deploy_status}

          Please find the unified report attached.

          Regards,
          GitHub Actions ðŸ¤–
          """

          msg.attach(MIMEText(body, "plain"))

          # Attach report
          with open("unified_report.html", "rb") as f:
              part = MIMEBase("application", "octet-stream")
              part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header(
                  "Content-Disposition",
                  "attachment; filename=unified_report.html"
              )
              msg.attach(part)

          # Send
          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls()
              server.login(sender, password)
              server.sendmail(sender, recipients, msg.as_string())

          print("Email sent successfully")
          EOF
