name: Python CI - Test, Deploy, and Cumulative Report

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  # ==========================
  # 1Ô∏è‚É£ Test Job
  # ==========================
  test:
    runs-on: ubuntu-latest
    outputs:
      test-result: ${{ steps.set-output.outputs.test_result }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html

      - name: Download previous report artifact
        uses: actions/download-artifact@v4
        with:
          name: full-ci-report
          path: old_report
        continue-on-error: true

      - name: Run application
        run: |
          python app.py | tee app.log

      - name: Run tests
        id: run_tests
        run: |
          pytest tests/test_example.py \
            --html=report.html \
            --self-contained-html \
            --capture=tee-sys | tee pytest.log
        continue-on-error: true

      - name: Merge previous logs
        run: |
          echo '<html><body><h1>CI Cumulative Report</h1>' > full_report.html
          if [ -f old_report/full_report.html ]; then
            echo '<h2>Previous Runs</h2>' >> full_report.html
            cat old_report/full_report.html >> full_report.html
          fi
          echo '<h2>New Application Logs</h2><pre>' >> full_report.html
          cat app.log >> full_report.html
          echo '</pre><h2>New Test Logs</h2><pre>' >> full_report.html
          cat pytest.log >> full_report.html
          echo '</pre></body></html>' >> full_report.html

      - name: Upload cumulative report
        uses: actions/upload-artifact@v4
        with:
          name: full-ci-report
          path: full_report.html

      - name: Set test result
        id: set-output
        run: |
          if grep -q "failed" pytest.log; then
            echo "test_result=fail" >> $GITHUB_OUTPUT
          else
            echo "test_result=success" >> $GITHUB_OUTPUT
          fi

  # ==========================
  # 2Ô∏è‚É£ Deploy Job
  # ==========================
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ needs.test.outputs.test-result == 'success' }} # deploy only if tests pass
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run deployment
        run: |
          chmod +x deploy.sh
          ./deploy.sh | tee deploy.log

      - name: Upload deployment logs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log

  # ==========================
  # 3Ô∏è‚É£ Email Job
  # ==========================
  email:
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()  # run email regardless of test or deploy status
    steps:
      - name: Download cumulative report
        uses: actions/download-artifact@v4
        with:
          name: full-ci-report
          path: .

      - name: Download deploy log
        uses: actions/download-artifact@v4
        with:
          name: deploy-log
          path: .

      - name: Send email with cumulative report
        run: |
          python - <<EOF
          import smtplib, ssl
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.base import MIMEBase
          from email import encoders
          import os

          sender_email = "${{ secrets.EMAIL_USERNAME }}"
          receiver_email = "slimihoussem1@gmail.com"
          password = "${{ secrets.EMAIL_PASSWORD }}"

          # Determine test and deploy status
          test_status = "PASSED" if "${{ needs.test.outputs.test-result }}" == "success" else "FAILED"
          deploy_status = "SKIPPED"
          if os.path.exists("deploy.log"):
              deploy_status = "SUCCEEDED" if os.path.getsize("deploy.log") > 0 else "FAILED"

          subject = f"CI Report - ${{ github.repository }}"

          msg = MIMEMultipart()
          msg['From'] = sender_email
          msg['To'] = receiver_email
          msg['Subject'] = subject

          body = f"""
          Hello Houssem,

          CI Run Summary:

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          Test Status: {test_status}
          Deployment Status: {deploy_status}

          The attached cumulative report contains:
          - Pytest HTML report (environment, summary, results)
          - Application logs (previous + new runs)
          - Deployment logs (if available)

          Regards,
          GitHub Actions ü§ñ
          """
          msg.attach(MIMEText(body, 'plain'))

          # Attach cumulative report
          if os.path.exists("full_report.html"):
              filename = "full_report.html"
              with open(filename, "rb") as attachment:
                  part = MIMEBase("application", "octet-stream")
                  part.set_payload(attachment.read())
                  encoders.encode_base64(part)
                  part.add_header("Content-Disposition", f"attachment; filename={filename}")
                  msg.attach(part)

          # Attach deploy.log if exists
          if os.path.exists("deploy.log"):
              filename = "deploy.log"
              with open(filename, "rb") as attachment:
                  part = MIMEBase("application", "octet-stream")
                  part.set_payload(attachment.read())
                  encoders.encode_base64(part)
                  part.add_header("Content-Disposition", f"attachment; filename={filename}")
                  msg.attach(part)

          context = ssl.create_default_context()
          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls(context=context)
              server.login(sender_email, password)
              server.sendmail(sender_email, receiver_email, msg.as_string())

          print("Email with cumulative report sent successfully!")
          EOF
